<dom-module id="sage-login">
    <style>
        :host {
            display: block;
        }

        div {
            padding-top: 2em;
        }
    </style>
    <template>
        <iron-ajax
             id="loginAjax"
             contentType="application/json"
             method="POST"
             verbose="true"
             url="/api/v1/auth/login"
             body="{{ajaxParams}}"
             handle-as="json"
             on-response="ajaxResponseHandler">
        </iron-ajax>

        <paper-input-container>
            <label>Email</label>
            <input required type="email" is="iron-input" value="{{email::input}}">
        </paper-input-container>

        <paper-input-container>
            <label>Password</label>
            <input required type="password" is="iron-input" value="{{password::input}}">
        </paper-input-container>

        <div class="horizontal layout justified">
            <template is="dom-if" if="{{isError}}">
                <p>
                    An error occured, email or password might be
                    incorrect.
                </p>
            </template>
            <span flex></span>
            <paper-fab
                 id="arrow"
                 icon="arrow-forward"
                 title="submit"
                 on-click="buttonSubmit"></paper-fab>
        </div>
   </template>
    
    <script>
        (function() {
            Polymer({
                is: 'sage-login',
                properties: {
                    email: {
                        type: String,
                        notify: true
                    },
                    password: {
                        type: String,
                        notify: true
                    },
                    ajaxParams: {
                        type: String,
                        computed: 'makeAjaxBody(email, password)'
                    },
                    isError: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                },
                buttonSubmit: function(event) {
                    console.log('submit', this.email, this.password);
                    this.$.loginAjax.generateRequest();
                },
                makeAjaxBody: function(email, password) {
        console.log('makeAjaxBody', JSON.stringify({'email': email, 'password':password}));
        return JSON.stringify({'email': email, 'password':password});
                },
                ajaxResponseHandler: function(event, response) {
                    var reply = response.xhr.response;
                    this.isError = reply.success;
                    if (reply.success) {
                        console.log('storing JWT');
                        window.localStorage.setItem('jwt', reply.jwt);
                        page.redirect('/upload');
                        this.fire('iron-signal', {name:'sage-auth-changed', data:true});
                    }
                }
            });
        })();
  </script>
    
</dom-module>
